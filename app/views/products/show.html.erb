<div class="container-fluid main_frontend">
	<ol class="breadcrumb">
	  <li><a href="#">首頁</a></li>
	  <li><a href="#">合作農場</a></li>
	  <li>
	  	<a href="/companies/<%=@product.company.id %>">
	  		<%unless @product.company.county.blank?%>
	  		<%= image_tag Hash[countyImageOptions].rassoc(@product.company.county).first, height: '70' %> 
	  		<%else%>
	  		<%= image_tag Hash[countyImageOptions].rassoc('南海諸島').first, height: '70' %> 	  		
	  		<%end%>
	  		<%= @product.company.name %>
	  	</a>
	  </li>
	  <li class="active"><%= @product.name %></li>	




	  <li class="active">
	  	
	  	<%= Order.joins(product_boxing: {}, invoice: {} ).where('product_boxings.id = ? and invoices.confirmed_c = ? and invoices.allpay_expired_at > ? ', @product.product_boxings.first.id, false, Time.now ).sum(:quantity)%>
	  	
		<% Order.joins(product_boxing: {}, invoice: {} ).where('product_boxings.id = ? and invoices.confirmed_c = ? and invoices.allpay_expired_at > ? ', @product.product_boxings.first.id, false, Time.now ).each do |o|%>
  			<%=o.id%>---<%=o.quantity%>!!
	  	<%end%>
	  	
	  </li>	



	  
	</ol>
	<div class="row">
		<div class="hidden-xs col-md-12 col-lg-offset-2 col-lg-8 product_farm_description">		
				<%= image_tag @product.company.user.avatar.url, class: 'img-circle product_farm_description_avatar' %>		
				<%=link_to @product.company do%>
				<div class="product_farm_description_text">	
				<%= truncate( @product.company.description, length: 122, omission: '... more') %>
				</div>
				<%end%>
		</div>				
		<div class="visible-xs-block col-xs-12 product_farm_description">		
			<div class="row">
				<div class="col-xs-12 text-center">					
				<%= image_tag @product.company.user.avatar.url, class: 'img-circle product_farm_description_avatar', style: '' %>		
				</div>
				<%=link_to @product.company do%>				
				<div class="col-xs-12 product_farm_description_text">	
				<%= truncate( @product.company.description, length: 122, omission: '... more') %>
				</div>
				<%end%>				
			</div>
		</div>			
	</div>	
	<div class="row" style="margin-top: 30px;">
		<div class="col-md-6 col-lg-offset-1 col-lg-5">		
			<div id="carousel-example-generic" class="product_carousel carousel slide" data-ride="carousel" data-interval="4000" data-pause="hover" style="margin: 10px auto; ">
			  <ol class="product_carousel-indicators carousel-indicators">
				<% @product.product_images.each_with_index do |p, i|%> 
					<%if i==0%>
			    	<li data-target="#carousel-example-generic" data-slide-to="<%=i%>" class="active"></li>
				    <%else%>
			    	<li data-target="#carousel-example-generic" data-slide-to="<%=i%>"></li>    
				    <%end%>
				<%end%>  		 	     
			  </ol>
			  <div class="product_carousel-inner carousel-inner" role="listbox">
				<% @product.product_images.each_with_index do |p, i|%>
					<%if i==0%>
					    <div class="product_item item active">
					      <div class="product_carousel_img">	
					      <%=image_tag p.image.url(:medium), class: '' %>
					      </div>
					    </div>
				    <%else%>
					    <div class="product_item item">
					      <div class="product_carousel_img">	
					      <%=image_tag p.image.url(:medium), class: '' %>
					      </div>
					    </div>	    
				    <%end%>
				<%end%>  	   
			  </div>
			  <a class="left product_carousel-control carousel-control hidden-xs" href="#carousel-example-generic" role="button" data-slide="prev">
			    <span class="glyphicon glyphicon-menu-left icon-prev" aria-hidden="true"></span>
			    <span class="sr-only">Previous</span>
			  </a>
			  <a class="right product_carousel-control carousel-control hidden-xs" href="#carousel-example-generic" role="button" data-slide="next">
			    <span class="glyphicon glyphicon-menu-right icon-next" aria-hidden="true"></span>
			    <span class="sr-only">Next</span>
			  </a>
			</div>					
		</div>
		<div class="col-md-6 col-lg-5">
			<div class="row">			
		      <div class="col-xs-12 col-md-offset-1 col-md-7 vmiddle text-center">
		        <div class="product_name"><%= @product.name %></div>
		        <div class="product_excellent"><span class="product_excellent_no" data-count='<%= Order.joins(product_boxing: :product, invoice: {} ).where('products.id = ? and delivered_c = 1 and review_score = ? ', @product.id, GLOBAL_VAR['ORDER_REVIEW_DELICIOUS']).count + Order.joins(product_boxing: :product, invoice: {} ).where('products.id = ? and delivered_c = 1 and review_score = ? ', @product.id, GLOBAL_VAR['ORDER_REVIEW_TASTY']).count %>'> </span><span class="product_excellent_text">人說好吃</span></div>	
		      </div>
		      <div class="col-md-3 hidden-xs hidden-sm vmiddle">
		      		<%if @product.sweet_degree%>
			  			<%=image_tag 'sweet_degree/'+@product.sweet_degree.to_s+'.png', class: 'product_sweet_degree pull-right' %>		      
		      		<%end%>
		      </div>		      
		    </div>				
			<div class="row">
		      <div class="hidden-xs hidden-sm col-md-offset-5 col-md-6 text-right" style="margin-top: 10px;">					
					<%if @product.daily_capacity.to_i*3 > @product.product_boxings.first.orders.joins(:invoice).where('invoices.confirmed_c = ? and called_smallfarmer_c = ?', true, false).sum(:quantity)%>	
						<%=image_tag 'seven_days.png', class: '', style: 'width: 130px; margin-left: 5px;'  %>					
					<%end%>					
					<%if @product.GAP_c%><%=image_tag 'gap.png', class: '', style: 'height: 55px; width: 55px; margin-left: 5px;'  %><%end%>		      
					<%if @product.TAP_c%><%=image_tag 'tap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      
					<%if @product.OTAP_c%><%=image_tag 'otap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      
					<%if @product.UTAP_c%><%=image_tag 'utap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      		      
		      </div>
		      <div class="hidden-md hidden-lg col-xs-12 text-center" style="margin-top: 10px;">				
					<%if @product.daily_capacity.to_i*3 > @product.product_boxings.first.orders.joins(:invoice).where('invoices.confirmed_c = ? and called_smallfarmer_c = ?', true, false).sum(:quantity)%>						
						<%=image_tag 'seven_days.png', class: '', style: 'width: 110px; margin-left: 5px;'  %>										
					<%end%>											
					<%if @product.GAP_c%><%=image_tag 'gap.png', class: '', style: 'height: 55px; width: 55px; margin-left: 5px;'  %><%end%>		      
					<%if @product.TAP_c%><%=image_tag 'tap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      
					<%if @product.OTAP_c%><%=image_tag 'otap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      
					<%if @product.UTAP_c%><%=image_tag 'utap.png', class: '', style: 'height: 50px; width: 50px; margin-left: 5px;'  %><%end%>		      		      		      
		      		<%if @product.sweet_degree%>
			  			<%=image_tag 'sweet_degree/'+@product.sweet_degree.to_s+'.png', class: 'product_sweet_degree', style:'height: 50px; width: 80px; margin-left: 5px;' %>		      
		      		<%end%>			   
					<div class="fb-share-button" style="margin-left: 5px;" data-href="https://developers.facebook.com/docs/plugins/" data-layout="button_count"></div>		      	      		  
		      </div>		      
		    </div>		
			<div class="row hidden-xs hidden-sm ">
		      <div class="col-sm-offset-5 col-sm-6 text-right" style="margin-top: 15px;">
				<div class="fb-share-button" data-href="https://developers.facebook.com/docs/plugins/" data-layout="button_count"></div>		      
		      </div>
		    </div>			    
			<div class="row product_price" style="margin-top: 20px;">
			<%@product.product_boxings.first.product_pricings.each do |p| %>
				<%if p.quantity == 1%>	
					<div class="hidden-xs hidden-sm col-xs-offset-0 col-sm-offset-2 col-sm-4 text-right">							
					    每箱 <%if @product.product_boxings.first.quantity%><%= "%g" % @product.product_boxings.first.quantity %><%end%><%if @product.unit%><%= Hash[unitOptions].rassoc(@product.unit).first %><%end%>
					</div>	   
					<div class="hidden-xs hidden-sm col-sm-3 text-right">						
						<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>				
					</div>	
					<div class="hidden-xs hidden-sm col-sm-2">元<span style="font-size: 85%">(含運)<span></div>														
					<div class="col-sm-12 hidden-md hidden-lg text-center">
					每箱 <%if @product.product_boxings.first.quantity%><%= "%g" % @product.product_boxings.first.quantity %><%end%><%if @product.unit%><%= Hash[unitOptions].rassoc(@product.unit).first %><%end%>				
					<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>								
					元<span style="font-size: 85%">(含運)<span>					
					</div>													
			</div>
			<div class="row product_price" style="margin-top: 10px;">
					<div class="col-xs-3 col-md-offset-2 col-md-4 text-right">數量</div>					
					<div class="col-xs-6 col-md-3">	
					<%= select_tag  :quantity, options_for_select( (1..50).step(1).to_a), class: "form-control" %>				
					</div>	  
					<div class="col-xs-3 col-md-2">箱</div>					 				
			</div>						
					<%elsif p.quantity%>
			<div class="row product_promote" style="margin-top: 18px;">	
					<div class="hidden-xs hidden-sm col-sm-offset-4 col-sm-7 text-right">								
						<%= p.quantity %>箱以上 每箱<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運)		
					</div>
					<div class="hidden-md hidden-lg col-xs-12 text-center">								
						<%= p.quantity %>箱以上 每箱<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運)		
					</div>					
			</div>						
					<%end%>
				<%end%>
			<div class="row" style="margin-top: 2px;">	
					<div class="hidden-xs hidden-sm col-sm-offset-4 col-sm-7 text-right">				
						＊企業團體購買，請聯絡客服人員
					</div>
					<div class="hidden-md hidden-lg col-xs-12 text-center">				
						＊企業團體購買，請聯絡客服人員
					</div>					
			</div>		
			<div class="row product_promote" style="margin-top: 20px;">					
					<div class="hidden-xs hidden-sm col-sm-11 text-right">							
						<button type="button" class="add_to_cart btn btn-success" autocomplete="off">加入購物車</button>			
					</div>
					<div class="hidden-md hidden-lg col-xs-12 text-center">							
						<button type="button" class="add_to_cart btn btn-success" autocomplete="off">加入購物車</button>			
					</div>					
			</div>	
		</div>
	</div>		
	<div class="row" style="font-size: 16px;">
		<div class="col-md-12 col-lg-offset-1 col-lg-5" style="margin-top: 40px; margin-bottom: 40px;">
			<div class="row" style="margin-bottom: 20px;">		
				<div class="col-sm-12">
					<div class="section_title">關於<%= @product.name %></div>
				</div>					
			</div>
			<div class="row" style="">		
				<div class="col-sm-7">
					<table class="table	product_spec">
					<tr><th>產地</th><td><%=@product.company.county %><%=@product.company.district%></td></tr>
					<tr><th>內容量</th><td>每箱 <%if @product.product_boxings.first.quantity%><%= "%g" % @product.product_boxings.first.quantity %><%end%><%if @product.unit%><%= Hash[unitOptions].rassoc(@product.unit).first %><%end%> </td></tr>
					<tr><th>保存方式</th><td><%= @product.preservation %></td></tr>		
					</table>	
				</div>	
				<div class="col-sm-5">
					<%unless @product.product_images.last.blank? %>
						<%=image_tag @product.product_images.last.image.url, class:'', style: 'width: 100%; border-radius: 10px;'%>
					<%end%>
				</div>								
			</div>		
			<div class="row" style="margin-top: 20px;">		
				<div class="col-sm-12">
				<%= simple_format( @product.description, {class: ''}, wrapper_tag: "div")%>												
				</div>								
			</div>					
		</div>
		<div class="col-lg-offset-1 col-lg-4" style="margin-top: 40px; margin-bottom: 40px;">
			<div class="row" style="margin-bottom: 20px;">		
				<div class="col-sm-6">
					<div class="section_title">金流去向</div>
				</div>					
			</div>			
			<div class="row">
				<div class="col-sm-12">				
				您選擇<span class="total_quantity"></span>箱，共<span class="total_price"></span>元，您最多可以獲得<span class="total_coupon"></span>元回饋金，金流估計如下：
				</div>
			</div	
			<br>
			<div class="farmer_get_layer">
				<div class="farmer_get_inner">
					<span class="total_farmer_get" style="position: relative; top: 45%"></span>
				</div>
				<div style="position: relative; top: 45%">農夫獲得</div>
			</div>
			<div class="shipping_rates_layer">
				<div class="shipping_rates_inner">
					<span class="total_shipping_rates" style="position: relative; top: 40%"></span>					
				</div>
				<div style="position: relative; top: 40%">物流費用</div>				
			</div>
			<div class="cash_flow_layer">
				<div class="cash_flow_inner">
					<span class="total_cash_flow" style="position: relative; top: 0%"></span>										
				</div>
				<div style="position: relative; top: 0%">金流費用</div>				
			</div>
			<div class="administration_layer">
				<div class="administration_inner">
					<span class="total_administration" style="position: relative; top: 0%"></span>										
				</div>
				<div style="position: relative; top: 0%">行政費用</div>				
			</div>									
			<div class="coupon_layer">
				<div class="coupon_inner">
					<span class="total_coupon" style="position: relative; top: 10%"></span>										
				</div>
				<div style="position: relative; top: 10%">您的回饋金</div>				
			</div>									
			<abbr title=""><small>(最後數據會依實際付款金額不同而改變)</small></abbr>
		</div>		
	</div>				
	<div class="row">
		<div class="col-md-12 col-lg-offset-1 col-lg-5" style="margin-top: 40px; margin-bottom: 40px; font-size: 16px;">	
			<div class="row" style="margin-bottom: 20px;">		
				<div class="col-sm-6">
					<div class="section_title">顧客評價</div>
				</div>					
			</div>				
			<div class="row" style="margin-bottom: 15px;">		
				<div class="col-sm-12">
					<span style="font-size: 22px;">累積評價</span><span> 自 <%=@product.created_at.strftime("%Y 年 %m 月 %d 日") %> 累積至今</span>
				</div>					
			</div>				
			<%= render partial: "products/review_score", locals: { product: @product} %>			
			<div class="row" style="margin-top: 15px;">		
				<div class="col-sm-6">
					<span style="font-size: 22px;">最新評價</span>
				</div>					
			</div>			
			<%= render partial: "products/review_feedback", locals: { product: @product} %>											
		</div>
		<div class="col-lg-5" style="margin-top: 40px; margin-bottom: 40px;">
			<div class="row" style="margin-bottom: 20px;">		
				<div class="col-md-12 col-lg-5">			
					<div class="section_title">留言</div>	
				</div>					
			</div>										
			<%= render partial: "comments/show", locals: { product: @product} %>			
		</div>		
	</div>	
	<div class="row" style="margin-top: 40px;">
		<div class="col-sm-offset-1 col-sm-10">
			<div class="row" style="margin-bottom: 40px;">		
				<div class="col-sm-6">
					<div class="section_title">推薦產品</div>
				</div>					
			</div>
			<%= render partial: "products/recommendation" %>											
		</div>
	</div>				    	
</div>				



<script>
var controller = new ScrollMagic.Controller({globalSceneOptions: {triggerHook: "onEnter", duration: "200%"}});
new ScrollMagic.Scene({triggerElement: ".product_excellent"})
		.addTo(controller)
		.on('start', function(e){
			$('.product_excellent_no').each(function () {
			  var $this = $(this);
			  jQuery({ Counter: 0 }).animate({ Counter: $this.attr("data-count") }, {
			    duration: 1000,
			    easing: 'swing',
			    step: function () {
			      $this.text(Math.floor(this.Counter));
			    },
			  	complete: function() {
			  		$this.html($this.attr("data-count"));
			  	}		    
			  });
			});					
		});	


// add cart
$('.add_to_cart').click(function() {
	//var $btn = $(this).button('加入中...')	
	var request = $.ajax({
		url: "/carts/addCart",
		type: "POST",
		data: { id: <%=@product.product_boxings.first.id%>, quantity: $('#quantity').val() },
		dataType: "json"
	});
	request.done(function( message ) {
		if(message.alert_class != 'success')
			toastr[message.alert_class](message.message)
	    //$btn.button('reset')		
	    showCarts();
 		//$('.cart-dropdown-menu').dropdown('toggle');	    
	});
	request.fail(function( jqXHR, textStatus ) {
	});	

});

//total price
var pricing =  []
var cash_flow_layer = 500;
<%@product.product_boxings.first.product_pricings.order('quantity desc').each do |p| %>
	pricing.push({ price: <%= p.price.to_i %>, quantity: <%= p.quantity %>  })
<%end%>
countTotalPrice($('#quantity').val())
function countTotalPrice(q){	
	$.each(pricing, function( index, value ) {
		if(q >= value.quantity)	
		{		
			total_price = q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>
			total_shipping_rates = q*<%=GLOBAL_VAR['SHIPPING_RATES']%>
			total_cash_flow = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*<%=GLOBAL_VAR['CASH_FLOW_FEE']%> )
			total_coupon = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*<%=GLOBAL_VAR['COUPON_FEE']%> )
			total_administration = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*<%=GLOBAL_VAR['ADMINISTRATION_FEE']%>  )
			total_farmer_get = q*value.price - total_administration - total_coupon - total_cash_flow 
			
			$('.total_price').html( total_price ); $('.total_quantity').html(q); 
			$('.total_farmer_get').html( total_farmer_get );	
			$('.total_shipping_rates').html( total_shipping_rates ); 							
			$('.total_cash_flow').html( total_cash_flow  );	
			$('.total_administration').html( total_administration  );			
			$('.total_coupon').html( total_coupon );

			$('.farmer_get_layer').css({"height": cash_flow_layer*(total_farmer_get/total_price)*0.6})
			$('.farmer_get_inner').css({"height": cash_flow_layer*(total_farmer_get/total_price)*0.6})
			$('.farmer_get_layer').animate({"height": cash_flow_layer*(total_farmer_get/total_price)}, 1000)
			$('.farmer_get_inner').animate({"height": cash_flow_layer*(total_farmer_get/total_price)}, 1000)
			$('.shipping_rates_layer').animate({"height": cash_flow_layer*(total_shipping_rates/total_price)})
			$('.shipping_rates_inner').animate({"height": cash_flow_layer*(total_shipping_rates/total_price)})
			$('.cash_flow_layer').animate({"height": cash_flow_layer*(total_cash_flow/total_price)})
			$('.cash_flow_inner').animate({"height": cash_flow_layer*(total_cash_flow/total_price)})
			$('.administration_layer').animate({"height": cash_flow_layer*(total_administration/total_price)})
			$('.administration_inner').animate({"height": cash_flow_layer*(total_administration/total_price)})										
			$('.coupon_layer').animate({"height": cash_flow_layer*(total_coupon/total_price)})
			$('.coupon_inner').animate({"height": cash_flow_layer*(total_coupon/total_price)})						
			return false;
		}	
	});		
}
$('#quantity').change(function(){
   countTotalPrice($('#quantity').val())
});	
</script>
