<div class="container-fluid main_frontend">
	<ol class="breadcrumb">
	  <li><a href="#">首頁</a></li>
	  <li><a href="#">合作農場</a></li>
	  <li>
	  	<a href="/companies/<%=@product.company.id %>">
	  		<%unless @product.company.county.blank?%>
	  		<%= image_tag Hash[countyImageOptions].rassoc(@product.company.county).first, height: '70' %> 
	  		<%else%>
	  		<%= image_tag Hash[countyImageOptions].rassoc('南海諸島').first, height: '70' %> 	  		
	  		<%end%>
	  		<%= @product.company.name %>
	  	</a>
	  </li>
	  <li class="active"><%= @product.name %></li>	
	</ol>
	<div class="row">
		<div class="col-sm-offset-2 col-sm-1 vmiddle">		
			<%= image_tag @product.company.user.avatar.url, class: 'img-circle', style: 'height: 90px; width: 90px;' %>
		</div>
		<div class="col-sm-7 vmiddle">			
			<%= simple_format(truncate( @product.company.description, length: 150, omission: '... more'), {class: 'product_farm_description'}, wrapper_tag: "div")%>			
		</div>				
	</div>	
	<div class="row" style="margin-top: 30px;">
		<div class="col-sm-offset-1 col-sm-6">		
			<div id="carousel-example-generic" class="product_carousel carousel slide" data-ride="carousel" data-interval="5000" data-pause="hover" style="margin: 10px auto; ">
			  <ol class="product_carousel-indicators carousel-indicators">
				<% @product.product_images.each_with_index do |p, i|%> 
					<%if i==0%>
			    	<li data-target="#carousel-example-generic" data-slide-to="<%=i%>" class="active"></li>
				    <%else%>
			    	<li data-target="#carousel-example-generic" data-slide-to="<%=i%>"></li>    
				    <%end%>
				<%end%>  		 	     
			  </ol>
			  <div class="product_carousel-inner carousel-inner" role="listbox">
				<% @product.product_images.each_with_index do |p, i|%>
					<%if i==0%>
					    <div class="product_item item active">
					      <div class="product_carousel_img">	
					      <%=image_tag p.image.url(:medium), class: '' %>
					      </div>
					    </div>
				    <%else%>
					    <div class="product_item item">
					      <div class="product_carousel_img">	
					      <%=image_tag p.image.url(:medium), class: '' %>
					      </div>
					    </div>	    
				    <%end%>
				<%end%>  	   
			  </div>
			  <a class="left product_carousel-control carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
			    <span class="glyphicon glyphicon-menu-left icon-prev" aria-hidden="true"></span>
			    <span class="sr-only">Previous</span>
			  </a>
			  <a class="right product_carousel-control carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
			    <span class="glyphicon glyphicon-menu-right icon-next" aria-hidden="true"></span>
			    <span class="sr-only">Next</span>
			  </a>
			</div>					
		</div>
		<div class="col-sm-4">
			<div class="row">
		      <div class="col-sm-3">
		        <div><%= @product.name %></div>
		        <div>3764人說好吃</div>	
		      </div>				
		      <div class="col-sm-6">
		        <div><%= @product.name %></div>
		        <div>3764人說好吃</div>	
		      </div>
		      <div class="col-sm-3">
		        18度
		      </div>		      
		    </div>				
			<div class="row">
		      <div class="col-sm-offset-6 col-sm-6">
		        TAP
		      </div>
		    </div>		
			<div class="row">
				<%@product.product_boxings.first.product_pricings.each do |p| %>
					<%if p.quantity == 1%>	
						<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運) <%= "%g" % @product.product_boxings.first.quantity %><%= Hash[unitOptions].rassoc(@product.unit).first %>/箱 <br>
						
					<div class="form-group form-inline">
						<label for="exampleInputName2">數量</label>
						<div class="col-sm-2">	
						<%= select_tag  :quantity, options_for_select( (1..50).step(1).to_a), class: "form-control" %>				
						</div>	   
						<div class="col-sm-2">
						</div>				
					</div>						
					<%else%>
						<%= p.quantity %>箱以上 每箱<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運)		
					<%end%>
					<br>
				<%end%>
				<div>＊企業團體購買，請聯絡客服人員</div>			
				<button type="button" class="add_to_cart btn btn-primary" autocomplete="off">加入購物車</button>			

		      </div>
		    </div>			    	
		</div>				
	</div>	




<p>
  <strong>Description:</strong>
  <%= @product.description %>
</p>

基本規格
<ul>
<li>產地 <%= @product.company.county%><%= @product.company.district%></li>
<li>保存方式 <%= @product.preservation%></li>
</ul>
<%@product.product_boxings.first.product_pricings.each do |p| %>
	<%if p.quantity == 1%>	
		<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運) <%= "%g" % @product.product_boxings.first.quantity %><%= Hash[unitOptions].rassoc(@product.unit).first %>/箱
	<%else%>
		<%= p.quantity %>箱以上 每箱<%= p.price.to_i+GLOBAL_VAR['SHIPPING_RATES'] %>元(含運)		
	<%end%>
	<br>
<%end%>
＊企業團體優惠，請聯絡客服人員
</p>


<p>

<span class="total_price"></span>元<br>
您選擇<span class="total_quantity"></span>箱，共<span class="total_price"></span>元，金流估計如下<br>
<br>
農夫獲得<span class="total_farmer_get"></span>元
<br>
物流費用<span class="total_shipping_rates"></span>元
<br>
金流費用<span class="total_cash_flow"></span>元
<br>
行政費用<span class="total_administration"></span>元
<br>
您的回饋金<span class="total_coupon"></span>元
<br>
<abbr title=""><small>(最後數據會依實際付款金額不同而改變)</small></abbr>
 
</div>

<%= link_to 'Edit', edit_product_path(@product) %> |
<%= link_to 'Back', products_path %>

<script>
$('.add_to_cart').click(function() {
	var $btn = $(this).button('loading')	
	var request = $.ajax({
		url: "/carts/addCart",
		type: "POST",
		data: { id: <%=@product.product_boxings.first.id%>, quantity: $('#quantity').val() },
		dataType: "json"
	});
	request.done(function( message ) {
		if(message.alert_class != 'success')
			addAlert(message.alert_class, message.message)
	    $btn.button('reset')		
	    showCarts();
 		//$('.cart-dropdown-menu').dropdown('toggle');	    
	});
	request.fail(function( jqXHR, textStatus ) {
	});	

});

//total price
var pricing =  []
<%@product.product_boxings.first.product_pricings.order('quantity desc').each do |p| %>
	pricing.push({ price: <%= p.price.to_i %>, quantity: <%= p.quantity %>  })
<%end%>
countTotalPrice($('#quantity').val())
function countTotalPrice(q){	
	$.each(pricing, function( index, value ) {
		if(q >= value.quantity)	
		{
			
			total_price = q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>
			total_shipping_rates = q*<%=GLOBAL_VAR['SHIPPING_RATES']%>
			total_cash_flow = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*0.028 )
			total_coupon = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*0.04 )
			total_administration = Math.round((q*value.price+q*<%=GLOBAL_VAR['SHIPPING_RATES']%>)*0.03 )
			total_farmer_get = q*value.price - total_administration - total_coupon - total_cash_flow 
			
			$('.total_price').html( total_price ); $('.total_quantity').html(q); 
			$('.total_farmer_get').html( total_farmer_get );	
			$('.total_shipping_rates').html( total_shipping_rates ); 							
			$('.total_cash_flow').html( total_cash_flow  );	
			$('.total_administration').html( total_administration  );			
			$('.total_coupon').html( total_coupon );
				
			return false;
		}	
	});		
}
$('#quantity').change(function(){
   countTotalPrice($('#quantity').val())
});	
</script>
<%= render partial: "comments/show", locals: { product: @product} %>