<nav class="navbar navbar-default navbar-fixed-top menu <%= navbarDefault %>">
	<div class="container-fluid">
    	<div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" <%if user_signed_in?%> onmouseover="showCartsNotifications();" <%end%> data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			<%if user_signed_in?%>          				
			<span class="badge badge-toggle badge-orange carts_notifications_badge"><%= cartsAndNotifications %></span>		            	           
            <%end%>
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
 		  <%=link_to root_url, class: 'navbar-brand' do%>
		  	<%=image_tag 'smallfarmer01.png', class: 'smallfarmer01-brand' %>
		  	<%=image_tag 'logo.png', class: 'logo-brand' %>
		  <%end%>     
          <form class="navbar-form collapsed no_collapse_point" role="search" action="/main/search" method="get">
            <div class="form-group">
            <input type="text" class="form-control rounded typeahead" name="query" placeholder="找商品、小農？" value="<%= @query %>">
    	  	</div>
    	  </form>  		      
        </div>    
        <div id="navbar" class="navbar-collapse collapse">   
		  <ul class="nav navbar-nav text-nav">
		  	<!--
            <li>
 		  		<%=link_to '/main/fruits' do%>
 		  		<%= image_tag 'menu/prime_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">小農嚴選</div>
 		  		<%end%>
            </li>       	
            -->
            <li>
 		  		<%=link_to '/main/farms' do%>
 		  		<%= image_tag 'menu/farmers_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">各地小農</div>
 		  		<%end%>
            </li>                   
            <li>
            	<%=link_to '/main/products?kind='+GLOBAL_VAR['KEYWORD_FRUITS'].to_s do%>
 		  		<%= image_tag 'menu/fruits_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">產地鮮果</div>
            	<%end%>
            </li>                
            <li>
            	<%=link_to '/main/products?kind='+GLOBAL_VAR['KEYWORD_GRAINS'].to_s do%>
 		  		<%= image_tag 'menu/grains_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">米麵雜糧</div>
            	<%end%>
            </li>
            <li>
            	<%=link_to '/main/products?kind='+GLOBAL_VAR['KEYWORD_PROCESSED'].to_s do%>
 		  		<%= image_tag 'menu/jams_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">小農手作</div>
            	<%end%>
            </li>
            <!--
            <li>
            	<%=link_to '/main/farms' do%>
 		  		<%= image_tag 'menu/roots_icon.png', class: 'text-nav_img' %>	            	
 		  		<div class="text-nav_text">根莖瓜果</div>
            	<%end%>
            </li>        
            -->                                       
          </ul>                   
          <form class="navbar-form navbar-left collapse_point" role="search" action="/main/search" method="get">
            <div class="form-group">
            <input type="text" class="form-control rounded typeahead search_term" name="query" placeholder="找商品、小農？" value="<%= @query %>">
    	  	</div>
    		<button type="submit" class="btn btn-default menu_search_button" style="display: none;"><%=image_tag 'logo_leaf_21x25.png'%></button>		    	  	
    	  </form>     	      
    	  <!--
          <form class="navbar-form hidden-sm hidden-md hidden-lg" role="search" action="/main/search" method="get">
            <input type="text" class="form-control rounded" name="query" placeholder="找關鍵字、商品、小農？" value="<%= @query %>">
    	  </form>      
  	          -->     	      	      	      	
          <ul class="nav navbar-nav navbar-right">
			<%if user_signed_in?%>          	
	            <li>
	            	<a href="/coupons/index" class="menu_right">
					<%= image_tag 'coupons_icon.png', class: '', style: '' %>	            	
			        <span class='mobile_menu_label no_collapse_point'>回饋金</span>
					<span class="badge badge-orange" style="font-size: 10px; border-radius: 0px; height: 13px; line-height: 13px; padding: 0px 3px; "><span class="menu_coupons"><%=coupons %></span></span>		            				        	            		            	           	
	            	</a>
	            </li>
	           	<li>
					<%= form_tag('/invoices/checkout', class: 'checkout_form') do -%>
		           		<a href="javascript:void(0)" class="menu_right no_collapse_point" onclick="$('.checkout_form').submit();" >
							<%= image_tag 'cart_icon.png', class: '', style: '' %>	            	
			            	<span class='mobile_menu_label'>購物車</span>
							<span class="badge badge-orange carts_badge"><%=carts%></span>		            	
			            </a>
					<% end -%>		           		
	           		<a class="dropdown-toggle menu_right collapse_point cart_menu_click" onmouseover="showCarts();" href="#" data-toggle="dropdown" aria-expanded="false">
						<%= image_tag 'cart_icon.png', class: 'menu_cart_icon', style: '' %>	            	
		            	<span class='mobile_menu_label no_collapse_point'>購物車<span class="caret"></span></span>
						<span class="badge badge-orange carts_badge"><%=carts%></span>		            	
		            	<span class="sr-only">Toggle Dropdown</span>
		            </a>
		            <div class="dropdown-menu cart-dropdown-menu" role="menu">
		            	<ul style="margin: 0; padding: 0; list-style: none; color: #000000" class="cart_lists">
		            	</ul>
		            	<div class='cart_label_container'>
		            	<span class="cart_label">總計</span><span class="cart_total">0</span>元
		            	</div>
						<%= form_tag('/invoices/checkout') do -%>
						<button class="btn btn-priamry orange_btn center-block menu_checkout_button" type="submit" style="padding: 5px 20px;">結帳</button>
						<% end -%>		            	
		            </div>               
	          	</li>
	            <li><a href="/notifications?category=all" class="menu_right">
					<%= image_tag 'notification_icon.png', class: '', style: '' %>	            	
		            <span class='mobile_menu_label no_collapse_point'>訊息中心</span>	            	
	            	<span class="badge badge-orange notifications_badge"><%=notifications%></span>
	            	</a>
	            </li>
				<li><a href="/invoices/index" class="menu_right">					
					<%= image_tag current_user.avatar.url, class: 'img-circle', style: 'border: 2px solid #a7a7a7' %>
		            <span class='mobile_menu_label no_collapse_point'><%if current_user.last_name%><%=current_user.last_name+' '+current_user.first_name%><%end%></span>					
					</a>			
				</li> 
	            <%if current_user.companies.first.activated_c%>
	            <li><a href="/orders/index?called_smallfarmer_c=false" class="menu_right">
					<%= image_tag 'farm_icon.png', class: '', style: '' %>	            	
		            <span class='mobile_menu_label no_collapse_point'>管理農場</span>	            	
	            	</a>
	            </li>	
	            <%end%>			    
			<%else%>	
				<li><%= link_to "註冊", new_user_registration_path %></li>
				<li><%= link_to "登入", new_user_session_path %></li>
			<%end%>					       
        </ul>
        </div>
	</div>
</nav>


<script>

function showCarts(){
	var request = $.ajax({
		url: "/carts/showCarts",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message ) {
		$(".cart_lists").empty();
		var q = 0; var total_price = 0;		
		if( message.length!=0 ) 
			$.each(  message , function( i, l ){				
				$(".cart_lists").append('<li id="'+l.id+'">'+
				'<a href="/products/'+l.id+'">'+
				'<img  class="cart_image img-circle" src="'+l.image_url+'">'+
				'<div class="cart_content">'+
				l.name+
				'<div style="margin-top: 3px;"><span class="cart_label"></span>'+l.quantity+'箱</div>'+
				'<div><span class="cart_label"></span>'+l.price+'元</div>'+
				'</div></a>'+
				'<div class="cart_op"><span class="" aria-hidden="true" onclick="destroyMenuCart('+l.cart_id+')" style="cursor: pointer">x</span></div>'+
				'</li>')
								
				q = q + l.quantity	
				total_price  = total_price + l.price
		 	});
		else
		{
			$(".cart_lists").append('購物車內沒有水果');	
		    $(".menu_checkout_button").attr('disabled','disabled');
		}		 	
	 	$('.cart_total').html(total_price);
	 	if(q!=0)
	 	{
	 		$('.carts_badge').html(q);
	 		$(".menu_checkout_button").removeAttr('disabled');
	 	}
	 	else
	 		$('.carts_badge').html('');
	 	showCartsNotifications();	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function destroyMenuCart(id){
	var request = $.ajax({
		url: "/carts/"+id.toString(),
		type: "DELETE",
		data: {},
		dataType: "json"
	});
	request.done(function( message ) {
	    showCarts();		
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function showNotifications(){
	var request = $.ajax({
		url: "/notifications/showNotifications",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message) {
	 	if( message.quantity != 0)
	 		$('.notifications_badge').html(message.quantity);
	 	else
	 		$('.notifications_badge').html('');	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function showCoupons(){
	var request = $.ajax({
		url: "/coupons/showCoupons",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message) {
	 	if( message.quantity != 0)
	 		$('.menu_coupons').html(message.quantity);
	 	else
	 		$('.menu_coupons').html('');	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function showCartsNotifications(){
	var request = $.ajax({
		url: "/main/showCartsNotifications",
		type: "GET",
		data: {},
		dataType: "json",
	});
	request.done(function( message ) {
		if(message.quantity!=0)
			$('.carts_notifications_badge').html(message.quantity);
		else
			 $('.carts_notifications_badge').html('');	
	});						
}

$('.navbar-right').on('show.bs.dropdown', function(e){
	$(this).find('.dropdown-menu').first().stop(true, true).slideDown();
});
$('.navbar-right').on('hide.bs.dropdown', function(e){
    $(this).find('.dropdown-menu').first().stop(true, true).slideUp();
});	
//==================================typeahead=================================//

var keyword_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('keyword'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=0',
    wildcard: '%QUERY'
  }
});
var product_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('product'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=1',
    wildcard: '%QUERY'
  }
});
var company_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('company'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=2',
    wildcard: '%QUERY'
  }
});
keyword_results.initialize();
product_results.initialize();
company_results.initialize();
$('.search_term').typeahead({  
  classNames: {
    menu: 'collapse_point tt-menu'
  }},
  {
  name: 'keywords',
  display: 'content',
  source: keyword_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">關鍵字</p>',
        suggestion: function (keyword) {
            return '<p><span class="target">' + keyword.content + '</span><span class="description">目前共' + keyword.size + '項商品</span></p>';
        }
  }},
  {
  name: 'products',  	
  display: 'product_name',
  source: product_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">商品</p>',
        suggestion: function (product) {
            return '<p><span class="target">' + product.product_name + '</span><span class="description">' + product.company_name +'</span></p>';
        }
  }},
  {
  name: 'companies',  	
  display: 'name',
  source: company_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">小農</p>',
        suggestion: function (company) {
            return '<p><span class="target">' + company.name +'</span></p>';
        }
  }}  
  );

//================================== cbp =================================//

//cbp
	var cbpAnimatedHeader = (function() {
	var docElem = document.documentElement,
		header = document.querySelector( '.menu' ),
		didScroll = false,
		changeHeaderOn = 50;
	function init() {
		window.addEventListener( 'scroll', function( event ) {
			if( !didScroll ) {
				didScroll = true;
				setTimeout( scrollPage, 250 );
			}
		}, false );
	}
	function scrollPage() {
		var sy = scrollY();
		if ( sy >= changeHeaderOn ) {
			classie.add( header, 'navbar-shrink' );
		}
		else {
			if( window.location.pathname != "/" && window.location.pathname != "/main/serviceIntro" )
				classie.remove( header, 'navbar-shrink' );
		}
		didScroll = false;
	}
	function scrollY() {
		return window.pageYOffset || docElem.scrollTop;
	}
	init();
//classie
	( function( window ) {	
	'use strict';	
	// class helper functions from bonzo https://github.com/ded/bonzo	
	function classReg( className ) {
	  return new RegExp("(^|\\s+)" + className + "(\\s+|$)");
	}
	// classList support for class management
	// altho to be fair, the api sucks because it won't accept multiple classes at once
	var hasClass, addClass, removeClass;	
	if ( 'classList' in document.documentElement ) {
	  hasClass = function( elem, c ) {
	    return elem.classList.contains( c );
	  };
	  addClass = function( elem, c ) {
	    elem.classList.add( c );
	  };
	  removeClass = function( elem, c ) {
	    elem.classList.remove( c );
	  };
	}
	else {
	  hasClass = function( elem, c ) {
	    return classReg( c ).test( elem.className );
	  };
	  addClass = function( elem, c ) {
	    if ( !hasClass( elem, c ) ) {
	      elem.className = elem.className + ' ' + c;
	    }
	  };
	  removeClass = function( elem, c ) {
	    elem.className = elem.className.replace( classReg( c ), ' ' );
	  };
	}	
	function toggleClass( elem, c ) {
	  var fn = hasClass( elem, c ) ? removeClass : addClass;
	  fn( elem, c );
	}	
	var classie = {
	  // full names
	  hasClass: hasClass,
	  addClass: addClass,
	  removeClass: removeClass,
	  toggleClass: toggleClass,
	  // short names
	  has: hasClass,
	  add: addClass,
	  remove: removeClass,
	  toggle: toggleClass
	};	
	// transport
	if ( typeof define === 'function' && define.amd ) {
	  // AMD
	  define( classie );
	} else {
	  // browser global
	  window.classie = classie;
	}
})( window );
})();
</script>