<nav class="navbar navbar-default navbar-fixed-top menu <%= navbarDefault %>">
	<div class="container-fluid">
    	<div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" onmouseover="showCartsNotifications();" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
			<%if user_signed_in?%>          				
			<span class="badge badge-toggle badge-danger carts_notifications_badge"><%= cartsAndNotifications %></span>		            	           
            <%end%>
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
 		  <%=link_to root_url, class: 'navbar-brand' do%>
		  	<%=image_tag 'smallfarmer01.png' %>
		  <%end%>         
        </div>
        <div id="navbar" class="navbar-collapse collapse">   
		  <ul class="nav navbar-nav text-nav">
            <li>
 		  		<%=link_to '/main/fruits' do%>
 		  		產地鮮果
 		  		<%end%>
            </li>
            <li class="li-divider">
            	<span>|</span>
            </li>          	
            <li>
            	<%=link_to '/main/farms' do%>
            	合作小農
            	<%end%>
            </li>
          </ul>          
          <form class="navbar-form navbar-left hidden-xs" role="search" action="/main/search" method="get">
            <div class="form-group">
            	<input type="text" class="form-control rounded typeahead search_term" name="query" placeholder="找關鍵字、鮮果、小農？" value="<%= @query %>">
    	  	</div>
    		<button type="submit" class="btn btn-default menu_search_button" style=""><%=image_tag 'logo_leaf_21x25.png'%></button> 		    	  	
    	  </form>     	    
          <form class="navbar-form hidden-sm hidden-md hidden-lg" role="search" action="/main/search" method="get">
            <input type="text" class="form-control rounded" name="query" placeholder="找關鍵字、鮮果、小農？" value="<%= @query %>">
    	  </form>        	       	  	               	      	      	      	
          <ul class="nav navbar-nav navbar-right">
			<%if user_signed_in?%>          	
	            <li>
	            	<a href="/coupons/index" class="menu_right">
					<%= image_tag 'coupons_icon.png', class: '', style: '' %>	            	
			        <span class='mobile_menu_label'>回饋金</span>	            	
	            	<span class="menu_coupons"><%=coupons %></span>	            	
	            	</a>
	            </li>
	           	<li>
					<%= form_tag('/invoices/checkout', class: 'checkout_form') do -%>
		           		<a href="javascript:void(0)" class="menu_right menu_cart_collapse" onclick="$('.checkout_form').submit();" >
							<%= image_tag 'cart_icon.png', class: '', style: '' %>	            	
			            	<span class='mobile_menu_label'>購物車</span>
							<span class="badge badge-danger carts_badge"><%=carts%></span>		            	
			            </a>
					<% end -%>		           		
	           		<a class="dropdown-toggle menu_right menu_cart_no_collapse" onmouseover="showCarts();" href="#" data-toggle="dropdown" aria-expanded="false">
						<%= image_tag 'cart_icon.png', class: 'menu_cart_icon', style: '' %>	            	
		            	<span class='mobile_menu_label'>購物車<span class="caret"></span></span>
						<span class="badge badge-danger carts_badge"><%=carts%></span>		            	
		            	<span class="sr-only">Toggle Dropdown</span>
		            </a>
		            <div class="dropdown-menu cart-dropdown-menu" role="menu">
		            	<ul style="margin: 0; padding: 0; list-style: none; color: #000000" class="cart_lists">
		            	</ul>
		            	<div class='cart_label_container'>
		            	<span class="cart_label">總計</span><span class="cart_total">0</span>元
		            	</div>
						<%= form_tag('/invoices/checkout') do -%>
						<button class="btn btn-priamry green_btn center-block menu_checkout_button" type="submit" style="padding: 5px 20px;">結帳</button>
						<% end -%>		            	
		            </div>               
	          	</li>
	            <li><a href="/notifications?category=all" class="menu_right">
					<%= image_tag 'notification_icon.png', class: '', style: '' %>	            	
		            <span class='mobile_menu_label'>訊息中心</span>	            	
	            	<span class="badge badge-danger notifications_badge"><%=notifications%></span>
	            	</a>
	            </li>
				<li><a href="/invoices/index" class="menu_right">					
					<%= image_tag current_user.avatar.url, class: 'img-circle', style: '' %>
		            <span class='mobile_menu_label'><%if current_user.last_name%><%=current_user.last_name+' '+current_user.first_name%><%end%></span>					
					</a>			
				</li> 
	            <%if current_user.companies.first.activated_c%>
	            <li><a href="/orders/index?called_smallfarmer_c=false" class="menu_right">
					<%= image_tag 'farm_icon.png', class: '', style: 'height: 34px; width: 38px' %>	            	
		            <span class='mobile_menu_label'>管理農場</span>	            	
	            	</a>
	            </li>	
	            <%end%>			    
			<%else%>	
				<li><%= link_to "註冊", new_user_registration_path %></li>
				<li><%= link_to "登入", new_user_session_path %></li>
			<%end%>					       
          </ul>
        </div>
	</div>
</nav>

<script>
function showCarts(){
	var request = $.ajax({
		url: "/carts/showCarts",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message ) {
		$(".cart_lists").empty();
		var q = 0; var total_price = 0;		
		if( message.length!=0 ) 
			$.each(  message , function( i, l ){				
				$(".cart_lists").append('<li id="'+l.id+'">'+
				'<a href="/products/'+l.id+'">'+
				'<img  class="cart_image img-circle" src="'+l.image_url+'">'+
				'<div class="cart_content">'+
				l.name+
				'<div style="margin-top: 7px;"><span class="cart_label"></span>'+l.quantity+'箱</div>'+
				'<div><span class="cart_label"></span>'+l.price+'元</div>'+
				'</div></a>'+
				'<div class="cart_op"><span class="" aria-hidden="true" onclick="destroyMenuCart('+l.cart_id+')" style="cursor: pointer">x</span></div>'+
				'</li>')
								
				q = q + l.quantity	
				total_price  = total_price + l.price
		 	});
		else
		{
			$(".cart_lists").append('購物車內沒有水果');	
		    $(".menu_checkout_button").attr('disabled','disabled');
		}		 	
	 	$('.cart_total').html(total_price);
	 	if(q!=0)
	 	{
	 		$('.carts_badge').html(q);
	 		$(".menu_checkout_button").removeAttr('disabled');
	 	}
	 	else
	 		$('.carts_badge').html('');
	 	showCartsNotifications();	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function destroyMenuCart(id){
	var request = $.ajax({
		url: "/carts/"+id.toString(),
		type: "DELETE",
		data: {},
		dataType: "json"
	});
	request.done(function( message ) {
	    showCarts();		
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function showNotifications(){
	var request = $.ajax({
		url: "/notifications/showNotifications",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message) {
	 	if( message.quantity != 0)
	 		$('.notifications_badge').html(message.quantity);
	 	else
	 		$('.notifications_badge').html('');	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}
function showCoupons(){
	var request = $.ajax({
		url: "/coupons/showCoupons",
		type: "GET",
		data: {},
		dataType: "json"
	});
	request.done(function( message) {
	 	if( message.quantity != 0)
	 		$('.menu_coupons').html(message.quantity);
	 	else
	 		$('.menu_coupons').html('');	
	});
	request.fail(function( jqXHR, textStatus ) {
	});		
}

function showCartsNotifications(){
	var request = $.ajax({
		url: "/main/showCartsNotifications",
		type: "GET",
		data: {},
		dataType: "json",
	});
	request.done(function( message ) {
		if(message.quantity!=0)
			$('.carts_notifications_badge').html(message.quantity);
		else
			 $('.carts_notifications_badge').html('');	
	});						
}

$('.navbar-right').on('show.bs.dropdown', function(e){
	$(this).find('.dropdown-menu').first().stop(true, true).slideDown();
});
$('.navbar-right').on('hide.bs.dropdown', function(e){
    $(this).find('.dropdown-menu').first().stop(true, true).slideUp();
});	
//==================================typeahead=================================//

var keyword_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('keyword'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=0',
    wildcard: '%QUERY'
  }
});
var product_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('product'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=1',
    wildcard: '%QUERY'
  }
});
var company_results = new Bloodhound({
  datumTokenizer: Bloodhound.tokenizers.obj.whitespace('company'),
  queryTokenizer: Bloodhound.tokenizers.whitespace,
  remote: {
    url: '/main/typeaheadSource?query=%QUERY&kind=2',
    wildcard: '%QUERY'
  }
});
keyword_results.initialize();
product_results.initialize();
company_results.initialize();
$('.search_term').typeahead(null, 
  {
  name: 'keywords',
  display: 'content',
  source: keyword_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">關鍵字</p>',
        suggestion: function (keyword) {
            return '<p><span class="target">' + keyword.content + '</span><span class="description">目前共' + keyword.size + '項商品</span></p>';
        }
  }},
  {
  name: 'products',  	
  display: 'product_name',
  source: product_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">商品</p>',
        suggestion: function (product) {
            return '<p><span class="target">' + product.product_name + '</span><span class="description">' + product.company_name +'</span></p>';
        }
  }},
  {
  name: 'companies',  	
  display: 'name',
  source: company_results,
  limit: 5,
  templates: {
  		header: '<p class="tt-header">小農</p>',
        suggestion: function (company) {
            return '<p><span class="target">' + company.name +'</span></p>';
        }
  }}  
  );

</script>