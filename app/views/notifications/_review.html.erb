<div class="col-sm-8">
	<% notification.invoice.orders.each do |o| %>
	<div class="row">
		<div class="col-sm-2">
			<%= image_tag o.product_boxing.product.product_images.first.image.url, class: 'img-circle farm_fruits_img', size: '100x100' %>				
		</div>	
		<div class="col-sm-1">
			<%= image_tag o.invoice.user.avatar.url, class: 'img-circle', size: '50x50' %>				
		</div>		
		<div class="col-sm-8">
			<div class="input-group">
		    	<div class="btn-group radioBtn">
		    		<a class="btn btn-primary btn-sm active" data-toggle="review_score_<%= o.id %>" data-title="<%= GLOBAL_VAR['ORDER_REVIEW_DELICIOUS'] %>">非吃不可</a>
		            <a class="btn btn-primary btn-sm notActive" data-toggle="review_score_<%= o.id %>" data-title="<%= GLOBAL_VAR['ORDER_REVIEW_TASTY'] %>">好吃</a>
		    		<a class="btn btn-primary btn-sm notActive" data-toggle="review_score_<%= o.id %>" data-title="<%= GLOBAL_VAR['ORDER_REVIEW_COMMON'] %>">普通</a>
		    	</div>
		    	<input type="hidden" name="review_score_<%= o.id %>" id="review_score_<%= o.id %>" vaule="<%= GLOBAL_VAR['ORDER_REVIEW_DELICIOUS'] %>">
		    </div><br>
			<div class="talkbubble"><textarea name="content" class="form-control" rows="2" placeholder='有什麼評價...' id="review_feedback_<%= o.id %>"></textarea></div>
		</div>			
	</div>	
	<%end%>
	<div class="row notification_button_<%= notification.id %>">	
		<div class="col-sm-11">
			<button class="btn btn-default pull-right comment_button" id="post_button" onclick="sendReview(<%= notification.id %>, <%=notification.invoice.id%>, <%=notification.invoice.orders.pluck(:id)%>)" data-loading-text="傳送中...">送出，立即獲得4%回饋金</button>		
		</div>
	</div>			
</div>


<style>
#radioBtn .notActive{
    color: #3276b1;
    background-color: #fff;
}
</style>
<script>
$('.radioBtn a').on('click', function(){
	var sel = $(this).data('title');
	var tog = $(this).data('toggle');
	$('#'+tog).prop('value', sel);	    
	$('a[data-toggle="'+tog+'"]').not('[data-title="'+sel+'"]').removeClass('active').addClass('notActive');
	$('a[data-toggle="'+tog+'"][data-title="'+sel+'"]').removeClass('notActive').addClass('active');
})
	
function sendReview( notification_id, invoice_id, orders)
{
	review_scores = [];
	review_feedbacks = [];
	$.each( orders, function( index, value ) {
	  review_scores.push( $( "#review_score_"+value ).val() )
	  review_feedbacks.push( $( "#review_feedback_"+value ).val() )	  
	});	

	var request = $.ajax({
		url: "/notifications/review",
		type: "POST",
		data: { id: notification_id, review_scores: review_scores, review_feedbacks: review_feedbacks },
		dataType: "json"
		});
		request.done(function( status ) {
			toastr[status.type](status.message)			
			showCoupons()						
			showNotifications()	
			$.each( orders, function( index, value ) {
			  $( "#review_feedback_"+value ).attr("disabled", "disabled")
			  $('.radioBtn a').off();				  
			  $('.notification_button_'+notification_id).remove();			   	  
			});					
		});
	
}	
</script>

	
