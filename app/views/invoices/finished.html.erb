<div class="container main_frontend">	
	<div class="row">
		<div class="col-sm-12">	
		<div class="text-center" style="font-size: 30px;"><%=@invoice.created_at.strftime("%Y-%m-%d %H:%M:%S") %></div>
		<div class="text-center" style="font-size: 40px;">訂購成功！</div>
		</div>
	</div>	
	<div class="row">
		<div class="col-sm-12" style="font-size: 20px;">	
		訂單編號 <%=@invoice.id %>
		</div>
	</div>	
	<div class="row" style="border: 1px solid #526031">
		<div class="col-sm-12">	
			<div class="row" style="margin-top: 30px;">
				<div class="col-sm-offset-1 col-sm-10 check_out_product_list_text">	
					<div>
						<%=@invoice.user.last_name%> <%=@invoice.user.first_name%> 您好：
					</div>
					<div>
						謝謝您在小農1號購買水果。我們會盡快將您所購買的水果寄送到您手中。您可以利用
						<%= link_to '我的訂單', {controller: 'invoices', action: 'index'}%>			 		
						查看您訂單的最新處理進度。若您有任何問題請聯絡客服人員。
					</div>	
				</div>
			</div>	
			<div class="row" style="margin-top: 20px;">
				<div class="col-sm-offset-1 col-sm-5">	
					<div class="row">
						<label class="col-sm-12 control-label">訂購人資訊</label>
					</div>	
					<div class="row">
					<label class="col-sm-4 control-label">姓名</label>
					<div class="form-inline col-sm-8">
						<%= current_user.addresses.first.last_name%>
						<%= current_user.addresses.first.first_name%>			
					</div>
					</div>
					<div class="row">
						<label class="col-sm-4 control-label">行動電話</label>
						<div class="col-sm-8">
								<%= current_user.addresses.first.phone_no.gsub(/^\+886/, '0')%>
						</div>		
					</div>		
					<div class="row">
							<label class="col-sm-4 control-label">聯絡地址</label>
							<div class="form-inline col-sm-8">
								<%= current_user.addresses.first.postal%> <%= current_user.addresses.first.county%><%= current_user.addresses.first.district%><%= current_user.addresses.first.address%>
							</div>
					</div>
					<div class="row">
						<label class="col-sm-4 control-label">聯絡信箱</label>
						<div class="form-inline col-sm-8">
							<%= current_user.email %>
						</div>
					</div>		
				</div>
				<div class="col-sm-5">					  
					<div class="row">
						<label class="col-sm-12 control-label">收件人資訊</label>
					</div>		
					<div class="row">
						<label class="col-sm-4 control-label">姓名</label>
						<div class="form-inline col-sm-8">
							<%= @invoice.receiver_last_name%>
							<%= @invoice.receiver_first_name%>			
						</div>
					</div>
					<div class="row">
						<label class="col-sm-4 control-label">聯絡電話</label>
						<div class="col-sm-8">		
							<%= @invoice.receiver_phone_no.gsub(/^\+886/, '0')%>		
						</div>		
					</div>		
					<div class="row">
						<label class="col-sm-4 control-label">聯絡地址</label>
						<div class="form-inline col-sm-8">
							<%= @invoice.receiver_postal%> <%= @invoice.receiver_county%><%= @invoice.receiver_district%><%= @invoice.receiver_address%>
						</div>
					</div>									
				</div>				
			</div>		
			<%@invoice.orders.each_with_index do |c, index| %>		
			<% product = c.product_boxing.product%>	
			<div class="row text-center" style="margin-top: 30px; margin-bottom: 30px;">
				<div class="col-sm-2 check_out_product_list_title vmiddle hidden-xs">
					出貨編號 <%= c.id%>	          		
				</div>	
				<div class="col-sm-2 col-xs-12 vmiddle">
					<%= image_tag product.product_images.first.image.url, class: 'img-circle farm_fruits_img', style: 'height: 70px; width: 70px;'%>						
				</div>	
				<div class="col-sm-2 col-xs-12 check_out_product_list_title vmiddle">
					<%= c.product_boxing.product.name %>
				</div>	
				<div class="col-sm-2 col-xs-12 check_out_product_list_text vmiddle">
					<% product.product_boxings.first.product_pricings.each do |pp| %>
						<%if pp.quantity == 1%>	
							每箱<%= "%g" % product.product_boxings.first.quantity %><%= Hash[unitOptions].rassoc(product.unit).first %> <%= pp.price.to_i+GLOBAL_VAR['SHIPPING_RATES']  %>元
						<%else%>
							<%= pp.quantity %>箱以上 每箱<%= pp.price.to_i + GLOBAL_VAR['SHIPPING_RATES']%>元		
						<%end%>
						<br>
					<%end%>  					
				</div>			
				<div class="col-sm-1 col-xs-12 check_out_product_list_text vmiddle">
					<%= c.quantity%>箱				
				</div>
				<div class="col-sm-1 col-xs-12 check_out_product_list_text vmiddle">
					<span class="total_price_<%=c.id%>"></span>元		
				</div>											
			</div>				
			<%end%>				
				
			<div class="row">
				<div class="col-sm-offset-1 col-sm-11">	
		    	<% discount = 0 %>
		    	<% @invoice.invoice_coupon_lists.each do |i_c_l|%>
		    		<%discount = discount + i_c_l.amount%>
		    	<%end%>						
				本次消費: <%=@invoice.amount.to_i%>元，使用回饋金: <%=discount.to_i%>元，
				總計: <%=(@invoice.amount - discount).to_i  %>元，付款方式為
				<%if @invoice.payment_method == GLOBAL_VAR['PAYMENT_METHOD_ALLPAY_CREDIT']%>	
						 線上刷卡 <%=image_tag 'allPay.png', class: 'img-responsive', size: '80x80', style: 'display: inline-block'%>	
				<%elsif @invoice.payment_method == GLOBAL_VAR['PAYMENT_METHOD_TCAT_COD']%>	
						 貨到付款 <%=image_tag 'cat.png', class: 'img-responsive', size: '80x80', style: 'display: inline-block'%> 		
				<%end%>					
				</div>
			</div>
			<div class="row">
				<div class="col-sm-offset-1 col-sm-11">	
					您可獲得回饋金<%= ((@invoice.amount-discount)*0.04).round%>元, 金流去向如下			
				</div>
			</div>			
			<div class="row"  style="margin-top: 30px">
				<div class="col-sm-offset-1 col-sm-11">	
					<div class="farmer_get_layer_horizon">
						<div class="farmer_get_inner_horizon">
							<span class="total_farmer_get" style="line-height: 60px;"></span>
						</div>
						<div style="width: 5px; margin: 10px auto;">農夫獲得</div>
					</div>
					<div class="shipping_rates_layer_horizon">
						<div class="shipping_rates_inner_horizon">
							<span class="total_shipping_rates" style="line-height: 60px;"></span>					
						</div>
						<div style="width: 5px; margin: 10px auto;">物流費用</div>				
					</div>
					<div class="cash_flow_layer_horizon">
						<div class="cash_flow_inner_horizon">
							<span class="total_cash_flow" style="line-height: 60px;"></span>										
						</div>
						<div style="width: 5px; margin: 10px auto;">金流費用</div>				
					</div>
					<div class="administration_layer_horizon">
						<div class="administration_inner_horizon">
							<span class="total_administration" style="line-height: 60px;"></span>										
						</div>
						<div style="width: 5px; margin: 10px auto;">行政費用</div>				
					</div>									
					<div class="coupon_layer_horizon">
						<div class="coupon_inner_horizon">
							<span class="total_coupon" style="line-height: 60px;"></span>										
						</div>
						<div style="width: 5px; margin: 10px auto;">您的回饋金</div>				
					</div>	
				</div>
			</div>								
		</div>
	</div>	
	<div class="row" style="margin-top: 20px;">
		<div class="col-sm-offset-10 col-sm-2">	
			<%= link_to '查看訂單狀態', {controller: 'invoices', action: 'index'}, class: 'btn btn-default green_btn' %>			 		
		</div>
	</div>		
	<div class="row" style="margin-top: 50px;">		
		<div class="col-sm-12">
			<div class="section_title">您可能感興趣</div>
			<div class="section_underline"></div>				
		</div>					
	</div>	
	
				
</div>			

		






<script>
//total price
var orders =  []
var income_to_layer = 1;
<%@invoice.orders.each do |o|%>    	    
	orders.push({ farmer_get: <%= ((o.price.to_i + o.shipping_rates.to_i)-(o.price.to_i + o.shipping_rates.to_i)*(0.098)-o.shipping_rates.to_i).round %>,
				  shipping_rates: <%= o.shipping_rates.to_i %>,
				  cash_flow: <%= ((o.price.to_i + o.shipping_rates.to_i)*0.028).round %>,
				  administration: <%= ((o.price.to_i + o.shipping_rates.to_i)*0.03).round %>		          
		       })
<%end%>
countTotalPrice()
function countTotalPrice(){	
	total = 0; total_shipping_rates = 0; 
	total_cash_flow = 0; total_administration = 0; 
	total_coupon = <%= ((@invoice.amount - discount)*0.04).round %>;
	total_farmer_get = 0;
	$.each(orders, function( index, value ) {
		total_shipping_rates += value.shipping_rates;
		total_cash_flow      += value.cash_flow;
		total_administration += value.administration;
		total_farmer_get += value.farmer_get
	});		
	total = total_shipping_rates + total_cash_flow + total_administration + total_farmer_get
			$('.farmer_get_layer_horizon').css({"width": ((total_farmer_get/total)*100*0.7).toString()+'%' })
			$('.farmer_get_layer_horizon').animate({"width": ((total_farmer_get/total)*100).toString()+'%' }, 1000)
			
			$('.shipping_rates_layer_horizon').animate({"width": ((total_shipping_rates/total)*100*0.6).toString()+'%'})
			$('.cash_flow_layer_horizon').animate({"width": ((total_cash_flow/total)*100*0.6).toString()+'%'})
			$('.administration_layer_horizon').animate({"width": ((total_administration/total)*100*0.6).toString()+'%'})
			$('.coupon_layer_horizon').animate({"width": ((total_coupon/total)*100*0.6).toString()+'%'})
			$('.total_farmer_get').html( total_farmer_get );	
			$('.total_shipping_rates').html( total_shipping_rates ); 							
			$('.total_cash_flow').html( total_cash_flow  );	
			$('.total_administration').html( total_administration  );			
			$('.total_coupon').html( total_coupon );	
}
</script>	